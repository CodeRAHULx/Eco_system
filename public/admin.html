<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - EcoCollect</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-green: #2e7d32;
        --light-green: #4caf50;
        --dark-green: #1b5e20;
      }
      body {
        background: #f5f5f5;
        font-family: "Segoe UI", system-ui, sans-serif;
      }
      .sidebar {
        background: linear-gradient(
          135deg,
          var(--dark-green),
          var(--primary-green)
        );
        min-height: 100vh;
        position: fixed;
        width: 250px;
        color: white;
        padding-top: 20px;
      }
      .sidebar .nav-link {
        color: rgba(255, 255, 255, 0.8);
        padding: 12px 20px;
        border-radius: 8px;
        margin: 4px 12px;
        transition: all 0.3s;
      }
      .sidebar .nav-link:hover,
      .sidebar .nav-link.active {
        background: rgba(255, 255, 255, 0.2);
        color: white;
      }
      .sidebar .nav-link i {
        margin-right: 10px;
        width: 20px;
      }
      .main-content {
        margin-left: 250px;
        padding: 20px;
      }
      .stat-card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        transition: transform 0.3s;
      }
      .stat-card:hover {
        transform: translateY(-5px);
      }
      .stat-card .icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
      }
      .stat-card .number {
        font-size: 28px;
        font-weight: 700;
      }
      .table-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        overflow: hidden;
      }
      .table-card .card-header {
        background: linear-gradient(
          135deg,
          var(--primary-green),
          var(--light-green)
        );
        color: white;
        padding: 15px 20px;
        font-weight: 600;
      }
      .status-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
      }
      .status-pending {
        background: #fff3e0;
        color: #e65100;
      }
      .status-assigned {
        background: #e3f2fd;
        color: #1565c0;
      }
      .status-active {
        background: #e8f5e9;
        color: #2e7d32;
      }
      .status-completed {
        background: #e8f5e9;
        color: #2e7d32;
      }
      .status-on-duty {
        background: #e8f5e9;
        color: #2e7d32;
      }
      .status-off-duty {
        background: #ffebee;
        color: #c62828;
      }
      .live-indicator {
        width: 10px;
        height: 10px;
        background: #4caf50;
        border-radius: 50%;
        display: inline-block;
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.5;
          transform: scale(1.2);
        }
      }
      .worker-card {
        background: white;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 10px;
        border-left: 4px solid var(--primary-green);
      }
      .worker-card.off-duty {
        border-left-color: #9e9e9e;
        opacity: 0.7;
      }
      #mapContainer {
        height: 400px;
        border-radius: 12px;
        overflow: hidden;
      }
      .modal-header {
        background: linear-gradient(
          135deg,
          var(--primary-green),
          var(--light-green)
        );
        color: white;
      }
      .modal-header .btn-close {
        filter: brightness(0) invert(1);
      }
      .refresh-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--primary-green);
        color: white;
        border: none;
        box-shadow: 0 4px 15px rgba(46, 125, 50, 0.4);
        font-size: 24px;
        z-index: 1000;
      }
      .logo {
        font-size: 24px;
        font-weight: 700;
        padding: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        margin-bottom: 20px;
      }
      .logo i {
        color: #8bc34a;
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="logo"><i class="bi bi-recycle"></i> EcoCollect</div>
      <nav class="nav flex-column">
        <a class="nav-link active" href="#" data-section="dashboard">
          <i class="bi bi-speedometer2"></i> Dashboard
        </a>
        <a class="nav-link" href="#" data-section="orders">
          <i class="bi bi-box-seam"></i> Orders
        </a>
        <a class="nav-link" href="#" data-section="workers">
          <i class="bi bi-people"></i> Workers
        </a>
        <a class="nav-link" href="#" data-section="drivers">
          <i class="bi bi-truck"></i> Drivers
        </a>
        <a class="nav-link" href="#" data-section="users">
          <i class="bi bi-person"></i> Users
        </a>
        <a class="nav-link" href="#" data-section="incidents">
          <i class="bi bi-exclamation-triangle"></i> Incidents
        </a>
        <a class="nav-link" href="#" data-section="tracking">
          <i class="bi bi-geo-alt"></i> Live Tracking
        </a>
        <hr class="mx-3" style="border-color: rgba(255, 255, 255, 0.2)" />
        <a class="nav-link" href="dashboard.html">
          <i class="bi bi-arrow-left"></i> Back to App
        </a>
        <a class="nav-link" href="#" id="logoutBtn">
          <i class="bi bi-box-arrow-right"></i> Logout
        </a>
      </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Dashboard Section -->
      <section id="dashboardSection">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4 class="mb-0">
            <i class="bi bi-speedometer2 text-success"></i> Admin Dashboard
          </h4>
          <span class="text-muted" id="lastUpdated">Last updated: --</span>
        </div>

        <!-- Stats Cards -->
        <div class="row g-3 mb-4">
          <div class="col-md-3">
            <div class="stat-card">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="text-muted small">Total Users</div>
                  <div class="number" id="statUsers">0</div>
                </div>
                <div class="icon bg-primary bg-opacity-10 text-primary">
                  <i class="bi bi-people"></i>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="text-muted small">Active Workers</div>
                  <div class="number">
                    <span id="statActiveWorkers">0</span>
                    <small class="text-muted"
                      >/ <span id="statTotalWorkers">0</span></small
                    >
                  </div>
                </div>
                <div class="icon bg-success bg-opacity-10 text-success">
                  <i class="bi bi-person-check"></i>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="text-muted small">Active Drivers</div>
                  <div class="number">
                    <span id="statActiveDrivers">0</span>
                    <small class="text-muted"
                      >/ <span id="statTotalDrivers">0</span></small
                    >
                  </div>
                </div>
                <div class="icon bg-info bg-opacity-10 text-info">
                  <i class="bi bi-truck"></i>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <div class="d-flex justify-content-between">
                <div>
                  <div class="text-muted small">Today's Orders</div>
                  <div class="number" id="statTodayOrders">0</div>
                </div>
                <div class="icon bg-warning bg-opacity-10 text-warning">
                  <i class="bi bi-calendar-check"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Order Stats -->
        <div class="row g-3 mb-4">
          <div class="col-md-3">
            <div
              class="stat-card text-center"
              style="border-left: 4px solid #ff9800"
            >
              <div class="text-warning fs-3 fw-bold" id="statPendingOrders">
                0
              </div>
              <div class="text-muted small">Pending Orders</div>
            </div>
          </div>
          <div class="col-md-3">
            <div
              class="stat-card text-center"
              style="border-left: 4px solid #2196f3"
            >
              <div class="text-primary fs-3 fw-bold" id="statInProgressOrders">
                0
              </div>
              <div class="text-muted small">In Progress</div>
            </div>
          </div>
          <div class="col-md-3">
            <div
              class="stat-card text-center"
              style="border-left: 4px solid #4caf50"
            >
              <div class="text-success fs-3 fw-bold" id="statCompletedOrders">
                0
              </div>
              <div class="text-muted small">Completed</div>
            </div>
          </div>
          <div class="col-md-3">
            <div
              class="stat-card text-center"
              style="border-left: 4px solid #f44336"
            >
              <div class="text-danger fs-3 fw-bold" id="statActiveIncidents">
                0
              </div>
              <div class="text-muted small">Active Incidents</div>
            </div>
          </div>
        </div>

        <!-- Recent Orders & Active Workers -->
        <div class="row g-3">
          <div class="col-md-8">
            <div class="table-card">
              <div
                class="card-header d-flex justify-content-between align-items-center"
              >
                <span><i class="bi bi-box-seam me-2"></i>Recent Orders</span>
                <a href="#" class="text-white" data-section="orders"
                  >View All</a
                >
              </div>
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Order ID</th>
                      <th>Customer</th>
                      <th>Waste Type</th>
                      <th>Status</th>
                      <th>Scheduled</th>
                    </tr>
                  </thead>
                  <tbody id="recentOrdersTable">
                    <tr>
                      <td colspan="5" class="text-center text-muted py-4">
                        Loading...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="table-card">
              <div class="card-header">
                <i class="bi bi-geo-alt me-2"></i>Active Workers
                <span class="live-indicator ms-2"></span>
              </div>
              <div class="p-3" id="activeWorkersList">
                <div class="text-center text-muted py-4">Loading...</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Orders Section -->
      <section id="ordersSection" style="display: none">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4 class="mb-0">
            <i class="bi bi-box-seam text-success"></i> Order Management
          </h4>
          <div>
            <select
              class="form-select d-inline-block w-auto me-2"
              id="orderStatusFilter"
            >
              <option value="">All Status</option>
              <option value="PENDING">Pending</option>
              <option value="ASSIGNED">Assigned</option>
              <option value="PICKED_UP">Picked Up</option>
              <option value="IN_TRANSIT">In Transit</option>
              <option value="COMPLETED">Completed</option>
              <option value="CANCELLED">Cancelled</option>
            </select>
            <input
              type="date"
              class="form-control d-inline-block w-auto"
              id="orderDateFilter"
            />
          </div>
        </div>
        <div class="table-card">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Order ID</th>
                  <th>Customer</th>
                  <th>Waste Types</th>
                  <th>Quantity</th>
                  <th>Scheduled</th>
                  <th>Status</th>
                  <th>Assigned To</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="allOrdersTable">
                <tr>
                  <td colspan="8" class="text-center text-muted py-4">
                    Loading...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Workers Section -->
      <section id="workersSection" style="display: none">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4 class="mb-0">
            <i class="bi bi-people text-success"></i> Worker Management
          </h4>
          <button
            class="btn btn-success"
            data-bs-toggle="modal"
            data-bs-target="#addWorkerModal"
          >
            <i class="bi bi-plus-lg"></i> Add Worker
          </button>
        </div>
        <div class="row" id="workersGrid">
          <div class="col-12 text-center text-muted py-4">Loading...</div>
        </div>
      </section>

      <!-- Drivers Section -->
      <section id="driversSection" style="display: none">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4 class="mb-0">
            <i class="bi bi-truck text-success"></i> Driver Management
          </h4>
          <button
            class="btn btn-success"
            data-bs-toggle="modal"
            data-bs-target="#addDriverModal"
          >
            <i class="bi bi-plus-lg"></i> Add Driver
          </button>
        </div>
        <div class="row" id="driversGrid">
          <div class="col-12 text-center text-muted py-4">Loading...</div>
        </div>
      </section>

      <!-- Users Section -->
      <section id="usersSection" style="display: none">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4 class="mb-0">
            <i class="bi bi-person text-success"></i> User Management
          </h4>
          <input
            type="text"
            class="form-control w-auto"
            placeholder="Search users..."
            id="userSearchInput"
          />
        </div>
        <div class="table-card">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Name</th>
                  <th>Phone</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Subscription</th>
                  <th>Joined</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="allUsersTable">
                <tr>
                  <td colspan="7" class="text-center text-muted py-4">
                    Loading...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Incidents Section -->
      <section id="incidentsSection" style="display: none">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4 class="mb-0">
            <i class="bi bi-exclamation-triangle text-success"></i> Incident
            Reports
          </h4>
        </div>
        <div class="table-card">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>ID</th>
                  <th>Type</th>
                  <th>Description</th>
                  <th>Severity</th>
                  <th>Status</th>
                  <th>Reporter</th>
                  <th>Reported At</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="allIncidentsTable">
                <tr>
                  <td colspan="8" class="text-center text-muted py-4">
                    Loading...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Live Tracking Section -->
      <section id="trackingSection" style="display: none">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h4 class="mb-0">
            <i class="bi bi-geo-alt text-success"></i> Live Tracking
            <span class="live-indicator ms-2"></span>
          </h4>
          <select class="form-select w-auto" id="trackingFilter">
            <option value="">All Active</option>
            <option value="WORKER">Workers Only</option>
            <option value="DRIVER">Drivers Only</option>
          </select>
        </div>
        <div class="row">
          <div class="col-md-8">
            <div class="table-card">
              <div class="card-header">Live Map</div>
              <div id="mapContainer">
                <div
                  class="d-flex align-items-center justify-content-center h-100 bg-light"
                >
                  <div class="text-center">
                    <i class="bi bi-map fs-1 text-muted"></i>
                    <p class="text-muted mt-2">
                      Map integration requires Google Maps API
                    </p>
                    <small class="text-muted"
                      >Add your API key to enable live map</small
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="table-card">
              <div class="card-header">Active Locations</div>
              <div
                class="p-3"
                style="max-height: 400px; overflow-y: auto"
                id="trackingList"
              >
                <div class="text-center text-muted py-4">Loading...</div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- Add Worker Modal -->
    <div class="modal fade" id="addWorkerModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-person-plus me-2"></i>Add New Worker
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="addWorkerForm">
              <div class="mb-3">
                <label class="form-label">Phone Number *</label>
                <input
                  type="tel"
                  class="form-control"
                  name="phone"
                  required
                  pattern="[0-9]{10}"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Full Name *</label>
                <input type="text" class="form-control" name="name" required />
              </div>
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" name="email" />
              </div>
              <div class="mb-3">
                <label class="form-label">Employee ID *</label>
                <input
                  type="text"
                  class="form-control"
                  name="employeeId"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Aadhar Number *</label>
                <input
                  type="text"
                  class="form-control"
                  name="aadharNumber"
                  required
                  pattern="[0-9]{12}"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Assigned Area</label>
                <input type="text" class="form-control" name="assignedArea" />
              </div>
              <div class="mb-3">
                <label class="form-label">Vehicle Number (Optional)</label>
                <input type="text" class="form-control" name="vehicleNumber" />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="submit" form="addWorkerForm" class="btn btn-success">
              Add Worker
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Driver Modal -->
    <div class="modal fade" id="addDriverModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-truck me-2"></i>Add New Driver
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="addDriverForm">
              <div class="mb-3">
                <label class="form-label">Phone Number *</label>
                <input
                  type="tel"
                  class="form-control"
                  name="phone"
                  required
                  pattern="[0-9]{10}"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Full Name *</label>
                <input type="text" class="form-control" name="name" required />
              </div>
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" name="email" />
              </div>
              <div class="mb-3">
                <label class="form-label">Employee ID *</label>
                <input
                  type="text"
                  class="form-control"
                  name="employeeId"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Aadhar Number *</label>
                <input
                  type="text"
                  class="form-control"
                  name="aadharNumber"
                  required
                  pattern="[0-9]{12}"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">License Number *</label>
                <input
                  type="text"
                  class="form-control"
                  name="licenseNumber"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Vehicle Number *</label>
                <input
                  type="text"
                  class="form-control"
                  name="vehicleNumber"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Vehicle Type</label>
                <select class="form-select" name="vehicleType">
                  <option value="GARBAGE_TRUCK">Garbage Truck</option>
                  <option value="PICKUP_TRUCK">Pickup Truck</option>
                  <option value="MINI_TRUCK">Mini Truck</option>
                  <option value="THREE_WHEELER">Three Wheeler</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Assigned Area</label>
                <input type="text" class="form-control" name="assignedArea" />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="submit" form="addDriverForm" class="btn btn-success">
              Add Driver
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Assign Order Modal -->
    <div class="modal fade" id="assignOrderModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Assign Order</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <p>Order: <strong id="assignOrderId"></strong></p>
            <div class="mb-3">
              <label class="form-label">Select Worker/Driver</label>
              <select class="form-select" id="assignWorkerSelect">
                <option value="">Loading...</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-success" id="confirmAssignBtn">
              Assign
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Refresh Button -->
    <button class="refresh-btn" onclick="refreshData()">
      <i class="bi bi-arrow-clockwise"></i>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API_BASE = "/api";
      let currentOrderId = null;

      // Check auth on load
      document.addEventListener("DOMContentLoaded", () => {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "/index.html";
          return;
        }

        // Check if user is admin
        checkAdminAccess();
        loadDashboard();
        setupEventListeners();
      });

      async function checkAdminAccess() {
        try {
          const res = await fetch(`${API_BASE}/users/profile`, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });
          const data = await res.json();

          const adminRoles = ["SUPER_ADMIN", "AREA_ADMIN", "SOCIETY_ADMIN"];
          if (!adminRoles.includes(data.user?.role)) {
            alert("Access Denied. Admin privileges required.");
            window.location.href = "/dashboard.html";
          }
        } catch (error) {
          console.error("Auth check failed:", error);
        }
      }

      function setupEventListeners() {
        // Navigation
        document.querySelectorAll(".nav-link[data-section]").forEach((link) => {
          link.addEventListener("click", (e) => {
            e.preventDefault();
            const section = e.currentTarget.dataset.section;
            showSection(section);
          });
        });

        // Logout
        document.getElementById("logoutBtn").addEventListener("click", (e) => {
          e.preventDefault();
          localStorage.removeItem("token");
          window.location.href = "/index.html";
        });

        // Add Worker Form
        document
          .getElementById("addWorkerForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            await addWorker(new FormData(e.target));
          });

        // Add Driver Form
        document
          .getElementById("addDriverForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            await addDriver(new FormData(e.target));
          });

        // Confirm Assign
        document
          .getElementById("confirmAssignBtn")
          .addEventListener("click", confirmAssignOrder);

        // Filters
        document
          .getElementById("orderStatusFilter")
          .addEventListener("change", loadOrders);
        document
          .getElementById("orderDateFilter")
          .addEventListener("change", loadOrders);
        document
          .getElementById("trackingFilter")
          .addEventListener("change", loadTracking);

        // User search
        let searchTimeout;
        document
          .getElementById("userSearchInput")
          .addEventListener("input", (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => loadUsers(e.target.value), 500);
          });
      }

      function showSection(sectionName) {
        // Hide all sections
        document
          .querySelectorAll(".main-content > section")
          .forEach((s) => (s.style.display = "none"));

        // Show selected section
        document.getElementById(sectionName + "Section").style.display =
          "block";

        // Update nav
        document
          .querySelectorAll(".nav-link")
          .forEach((l) => l.classList.remove("active"));
        document
          .querySelector(`[data-section="${sectionName}"]`)
          ?.classList.add("active");

        // Load section data
        switch (sectionName) {
          case "dashboard":
            loadDashboard();
            break;
          case "orders":
            loadOrders();
            break;
          case "workers":
            loadWorkers();
            break;
          case "drivers":
            loadDrivers();
            break;
          case "users":
            loadUsers();
            break;
          case "incidents":
            loadIncidents();
            break;
          case "tracking":
            loadTracking();
            break;
        }
      }

      async function loadDashboard() {
        try {
          const res = await fetch(`${API_BASE}/users/admin/dashboard`, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });
          const data = await res.json();

          if (data.success) {
            const s = data.stats;
            document.getElementById("statUsers").textContent = s.users.total;
            document.getElementById("statActiveWorkers").textContent =
              s.users.activeWorkers;
            document.getElementById("statTotalWorkers").textContent =
              s.users.workers;
            document.getElementById("statActiveDrivers").textContent =
              s.users.activeDrivers;
            document.getElementById("statTotalDrivers").textContent =
              s.users.drivers;
            document.getElementById("statTodayOrders").textContent =
              s.orders.today;
            document.getElementById("statPendingOrders").textContent =
              s.orders.pending;
            document.getElementById("statInProgressOrders").textContent =
              s.orders.inProgress;
            document.getElementById("statCompletedOrders").textContent =
              s.orders.completed;
            document.getElementById("statActiveIncidents").textContent =
              s.incidents.active;
          }

          // Load recent orders
          const ordersRes = await fetch(
            `${API_BASE}/orders/admin/all?limit=5`,
            {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            },
          );
          const ordersData = await ordersRes.json();

          if (ordersData.success && ordersData.orders.length > 0) {
            document.getElementById("recentOrdersTable").innerHTML =
              ordersData.orders
                .map(
                  (o) => `
                        <tr>
                            <td><strong>${o.orderId}</strong></td>
                            <td>${o.user?.profile?.name || "N/A"}</td>
                            <td>${o.wasteTypes?.slice(0, 2).join(", ") || "N/A"}</td>
                            <td><span class="status-badge status-${o.status?.toLowerCase()}">${o.status}</span></td>
                            <td>${new Date(o.scheduledDate).toLocaleDateString()}</td>
                        </tr>
                    `,
                )
                .join("");
          } else {
            document.getElementById("recentOrdersTable").innerHTML = `
                        <tr><td colspan="5" class="text-center text-muted py-4">No orders yet</td></tr>
                    `;
          }

          // Load active workers
          const workersRes = await fetch(`${API_BASE}/users/active-workers`, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });
          const workersData = await workersRes.json();

          if (workersData.success && workersData.workers.length > 0) {
            document.getElementById("activeWorkersList").innerHTML =
              workersData.workers
                .slice(0, 5)
                .map(
                  (w) => `
                        <div class="worker-card">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>${w.name}</strong>
                                    <div class="small text-muted">${w.role} - ${w.employeeId}</div>
                                </div>
                                <span class="live-indicator"></span>
                            </div>
                            ${w.vehicleNumber ? `<div class="small mt-1"><i class="bi bi-truck"></i> ${w.vehicleNumber}</div>` : ""}
                        </div>
                    `,
                )
                .join("");
          } else {
            document.getElementById("activeWorkersList").innerHTML = `
                        <div class="text-center text-muted py-4">No active workers</div>
                    `;
          }

          document.getElementById("lastUpdated").textContent =
            `Last updated: ${new Date().toLocaleTimeString()}`;
        } catch (error) {
          console.error("Dashboard load error:", error);
        }
      }

      async function loadOrders() {
        const status = document.getElementById("orderStatusFilter").value;
        const date = document.getElementById("orderDateFilter").value;

        let url = `${API_BASE}/orders/admin/all?limit=50`;
        if (status) url += `&status=${status}`;
        if (date) url += `&date=${date}`;

        try {
          const res = await fetch(url, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });
          const data = await res.json();

          if (data.success && data.orders.length > 0) {
            document.getElementById("allOrdersTable").innerHTML = data.orders
              .map(
                (o) => `
                        <tr>
                            <td><strong>${o.orderId}</strong></td>
                            <td>
                                ${o.user?.profile?.name || "N/A"}<br>
                                <small class="text-muted">${o.user?.phone || ""}</small>
                            </td>
                            <td>${o.wasteTypes?.join(", ") || "N/A"}</td>
                            <td>${o.estimatedQuantity} kg</td>
                            <td>
                                ${new Date(o.scheduledDate).toLocaleDateString()}<br>
                                <small class="text-muted">${o.scheduledTime}</small>
                            </td>
                            <td><span class="status-badge status-${o.status?.toLowerCase()}">${o.status}</span></td>
                            <td>${o.assignedWorker?.profile?.name || '<span class="text-muted">Unassigned</span>'}</td>
                            <td>
                                ${
                                  !o.assignedWorker
                                    ? `
                                    <button class="btn btn-sm btn-success" onclick="showAssignModal('${o._id}', '${o.orderId}')">
                                        <i class="bi bi-person-plus"></i>
                                    </button>
                                `
                                    : ""
                                }
                                <button class="btn btn-sm btn-outline-primary" onclick="viewOrder('${o._id}')">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `,
              )
              .join("");
          } else {
            document.getElementById("allOrdersTable").innerHTML = `
                        <tr><td colspan="8" class="text-center text-muted py-4">No orders found</td></tr>
                    `;
          }
        } catch (error) {
          console.error("Orders load error:", error);
        }
      }

      async function loadWorkers() {
        try {
          const res = await fetch(`${API_BASE}/users/admin/workers`, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });
          const data = await res.json();

          if (data.success && data.workers.length > 0) {
            document.getElementById("workersGrid").innerHTML = data.workers
              .map(
                (w) => `
                        <div class="col-md-4 mb-3">
                            <div class="worker-card ${!w.isOnDuty ? "off-duty" : ""}">
                                <div class="d-flex justify-content-between mb-2">
                                    <h6 class="mb-0">${w.name}</h6>
                                    <span class="status-badge ${w.isOnDuty ? "status-on-duty" : "status-off-duty"}">
                                        ${w.isOnDuty ? "On Duty" : "Off Duty"}
                                    </span>
                                </div>
                                <div class="small text-muted mb-2">
                                    <div><i class="bi bi-telephone"></i> ${w.phone}</div>
                                    <div><i class="bi bi-person-badge"></i> ${w.employeeId}</div>
                                    ${w.vehicleNumber ? `<div><i class="bi bi-truck"></i> ${w.vehicleNumber}</div>` : ""}
                                    ${w.assignedArea ? `<div><i class="bi bi-geo"></i> ${w.assignedArea}</div>` : ""}
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="bi bi-star-fill text-warning"></i> ${w.rating?.toFixed(1) || "N/A"}
                                        <span class="text-muted ms-2">${w.completedOrders || 0} orders</span>
                                    </div>
                                    <span class="badge bg-${w.status === "ACTIVE" ? "success" : "secondary"}">${w.status}</span>
                                </div>
                            </div>
                        </div>
                    `,
              )
              .join("");
          } else {
            document.getElementById("workersGrid").innerHTML = `
                        <div class="col-12 text-center text-muted py-4">No workers registered yet</div>
                    `;
          }
        } catch (error) {
          console.error("Workers load error:", error);
        }
      }

      async function loadDrivers() {
        try {
          const res = await fetch(`${API_BASE}/users/admin/drivers`, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });
          const data = await res.json();

          if (data.success && data.drivers.length > 0) {
            document.getElementById("driversGrid").innerHTML = data.drivers
              .map(
                (d) => `
                        <div class="col-md-4 mb-3">
                            <div class="worker-card ${!d.isOnDuty ? "off-duty" : ""}">
                                <div class="d-flex justify-content-between mb-2">
                                    <h6 class="mb-0">${d.name}</h6>
                                    <span class="status-badge ${d.isOnDuty ? "status-on-duty" : "status-off-duty"}">
                                        ${d.isOnDuty ? "On Duty" : "Off Duty"}
                                    </span>
                                </div>
                                <div class="small text-muted mb-2">
                                    <div><i class="bi bi-telephone"></i> ${d.phone}</div>
                                    <div><i class="bi bi-person-badge"></i> ${d.employeeId}</div>
                                    <div><i class="bi bi-truck"></i> ${d.vehicleNumber} (${d.vehicleType})</div>
                                    <div><i class="bi bi-card-text"></i> ${d.licenseNumber}</div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="bi bi-star-fill text-warning"></i> ${d.rating?.toFixed(1) || "N/A"}
                                        <span class="text-muted ms-2">${d.completedOrders || 0} orders</span>
                                    </div>
                                    <span class="badge bg-${d.status === "ACTIVE" ? "success" : "secondary"}">${d.status}</span>
                                </div>
                                ${
                                  d.isOnDuty && d.location
                                    ? `
                                    <div class="mt-2 small">
                                        <span class="live-indicator me-1"></span> 
                                        Last seen: ${new Date(d.location.lastUpdated).toLocaleTimeString()}
                                    </div>
                                `
                                    : ""
                                }
                            </div>
                        </div>
                    `,
              )
              .join("");
          } else {
            document.getElementById("driversGrid").innerHTML = `
                        <div class="col-12 text-center text-muted py-4">No drivers registered yet</div>
                    `;
          }
        } catch (error) {
          console.error("Drivers load error:", error);
        }
      }

      async function loadUsers(search = "") {
        try {
          let url = `${API_BASE}/users/admin/users?role=USER&limit=50`;
          if (search) url += `&search=${encodeURIComponent(search)}`;

          const res = await fetch(url, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });
          const data = await res.json();

          if (data.success && data.users.length > 0) {
            document.getElementById("allUsersTable").innerHTML = data.users
              .map(
                (u) => `
                        <tr>
                            <td>${u.name}</td>
                            <td>${u.phone}</td>
                            <td>${u.email}</td>
                            <td><span class="badge bg-secondary">${u.role}</span></td>
                            <td><span class="badge bg-${u.subscription?.plan === "FREE" ? "light text-dark" : "success"}">${u.subscription?.plan || "FREE"}</span></td>
                            <td>${new Date(u.createdAt).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `,
              )
              .join("");
          } else {
            document.getElementById("allUsersTable").innerHTML = `
                        <tr><td colspan="7" class="text-center text-muted py-4">No users found</td></tr>
                    `;
          }
        } catch (error) {
          console.error("Users load error:", error);
        }
      }

      async function loadIncidents() {
        try {
          const res = await fetch(`${API_BASE}/incidents/all?limit=50`, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });
          const data = await res.json();

          if (data.success && data.incidents?.length > 0) {
            document.getElementById("allIncidentsTable").innerHTML =
              data.incidents
                .map(
                  (i) => `
                        <tr>
                            <td>${i.incidentId}</td>
                            <td>${i.type}</td>
                            <td>${i.description?.substring(0, 50)}...</td>
                            <td><span class="badge bg-${i.severity === "critical" ? "danger" : i.severity === "high" ? "warning" : "info"}">${i.severity}</span></td>
                            <td><span class="status-badge status-${i.status}">${i.status}</span></td>
                            <td>${i.reporterName}</td>
                            <td>${new Date(i.createdAt).toLocaleString()}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `,
                )
                .join("");
          } else {
            document.getElementById("allIncidentsTable").innerHTML = `
                        <tr><td colspan="8" class="text-center text-muted py-4">No incidents reported</td></tr>
                    `;
          }
        } catch (error) {
          console.error("Incidents load error:", error);
        }
      }

      async function loadTracking() {
        const role = document.getElementById("trackingFilter").value;
        let url = `${API_BASE}/users/active-workers`;
        if (role) url += `?role=${role}`;

        try {
          const res = await fetch(url, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });
          const data = await res.json();

          if (data.success && data.workers.length > 0) {
            document.getElementById("trackingList").innerHTML = data.workers
              .map(
                (w) => `
                        <div class="worker-card mb-2">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>${w.name}</strong>
                                    <div class="small text-muted">${w.role} - ${w.vehicleNumber || "No vehicle"}</div>
                                </div>
                                <span class="live-indicator"></span>
                            </div>
                            <div class="small mt-2">
                                <i class="bi bi-geo-alt text-danger"></i>
                                ${w.location?.lat?.toFixed(4)}, ${w.location?.lng?.toFixed(4)}
                            </div>
                            <div class="small text-muted">
                                Speed: ${w.location?.speed || 0} km/h | 
                                Updated: ${w.location?.lastUpdated ? new Date(w.location.lastUpdated).toLocaleTimeString() : "N/A"}
                            </div>
                        </div>
                    `,
              )
              .join("");
          } else {
            document.getElementById("trackingList").innerHTML = `
                        <div class="text-center text-muted py-4">No active workers/drivers</div>
                    `;
          }
        } catch (error) {
          console.error("Tracking load error:", error);
        }
      }

      async function addWorker(formData) {
        const data = Object.fromEntries(formData.entries());

        try {
          const res = await fetch(`${API_BASE}/users/admin/register-worker`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
            body: JSON.stringify(data),
          });
          const result = await res.json();

          if (result.success) {
            alert("Worker added successfully!");
            bootstrap.Modal.getInstance(
              document.getElementById("addWorkerModal"),
            ).hide();
            document.getElementById("addWorkerForm").reset();
            loadWorkers();
            loadDashboard();
          } else {
            alert(result.message || "Failed to add worker");
          }
        } catch (error) {
          alert("Error adding worker: " + error.message);
        }
      }

      async function addDriver(formData) {
        const data = Object.fromEntries(formData.entries());

        try {
          const res = await fetch(`${API_BASE}/users/admin/register-driver`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
            body: JSON.stringify(data),
          });
          const result = await res.json();

          if (result.success) {
            alert("Driver added successfully!");
            bootstrap.Modal.getInstance(
              document.getElementById("addDriverModal"),
            ).hide();
            document.getElementById("addDriverForm").reset();
            loadDrivers();
            loadDashboard();
          } else {
            alert(result.message || "Failed to add driver");
          }
        } catch (error) {
          alert("Error adding driver: " + error.message);
        }
      }

      async function showAssignModal(orderId, orderDisplayId) {
        currentOrderId = orderId;
        document.getElementById("assignOrderId").textContent = orderDisplayId;

        // Load available workers
        try {
          const res = await fetch(`${API_BASE}/users/active-workers`, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });
          const data = await res.json();

          if (data.success) {
            document.getElementById("assignWorkerSelect").innerHTML = `
                        <option value="">Select a worker/driver</option>
                        ${data.workers
                          .map(
                            (w) => `
                            <option value="${w.id}">${w.name} (${w.role}) - ${w.vehicleNumber || "No vehicle"}</option>
                        `,
                          )
                          .join("")}
                    `;
          }
        } catch (error) {
          console.error("Error loading workers:", error);
        }

        new bootstrap.Modal(document.getElementById("assignOrderModal")).show();
      }

      async function confirmAssignOrder() {
        const workerId = document.getElementById("assignWorkerSelect").value;
        if (!workerId) {
          alert("Please select a worker");
          return;
        }

        try {
          const res = await fetch(
            `${API_BASE}/orders/admin/assign/${currentOrderId}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
              body: JSON.stringify({ workerId }),
            },
          );
          const data = await res.json();

          if (data.success) {
            alert("Order assigned successfully!");
            bootstrap.Modal.getInstance(
              document.getElementById("assignOrderModal"),
            ).hide();
            loadOrders();
            loadDashboard();
          } else {
            alert(data.message || "Failed to assign order");
          }
        } catch (error) {
          alert("Error assigning order: " + error.message);
        }
      }

      function viewOrder(orderId) {
        // TODO: Implement order detail modal
        alert("Order details view coming soon");
      }

      function refreshData() {
        const activeSection =
          document.querySelector(".nav-link.active")?.dataset?.section ||
          "dashboard";
        showSection(activeSection);
      }

      // Auto-refresh every 30 seconds
      setInterval(() => {
        refreshData();
      }, 30000);
    </script>
  </body>
</html>
