<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Worker Dashboard - EcoCollect</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-green: #2e7d32;
        --light-green: #4caf50;
      }
      body {
        background: #f5f5f5;
        font-family: "Segoe UI", system-ui, sans-serif;
        padding-bottom: 80px;
      }
      .header {
        background: linear-gradient(135deg, #1b5e20, var(--primary-green));
        color: white;
        padding: 20px;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      .duty-toggle {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 30px;
        padding: 8px 20px;
        cursor: pointer;
        transition: all 0.3s;
      }
      .duty-toggle.on-duty {
        background: #4caf50;
      }
      .duty-toggle.off-duty {
        background: #f44336;
      }
      .stats-row {
        display: flex;
        gap: 10px;
        padding: 15px;
        overflow-x: auto;
      }
      .stat-mini {
        background: white;
        border-radius: 12px;
        padding: 15px;
        min-width: 100px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }
      .stat-mini .number {
        font-size: 24px;
        font-weight: 700;
        color: var(--primary-green);
      }
      .order-card {
        background: white;
        border-radius: 16px;
        margin: 10px 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        overflow: hidden;
      }
      .order-card .header-strip {
        height: 4px;
        background: var(--primary-green);
      }
      .order-card.urgent .header-strip {
        background: #ff5722;
      }
      .order-card .content {
        padding: 15px;
      }
      .order-card .order-id {
        font-weight: 600;
        color: var(--primary-green);
      }
      .order-card .customer-name {
        font-weight: 500;
        font-size: 18px;
      }
      .order-card .waste-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin: 10px 0;
      }
      .order-card .waste-tag {
        background: #e8f5e9;
        color: var(--primary-green);
        padding: 4px 10px;
        border-radius: 15px;
        font-size: 12px;
      }
      .order-card .action-row {
        display: flex;
        gap: 10px;
        padding: 10px 15px;
        background: #f9f9f9;
      }
      .order-card .action-row .btn {
        flex: 1;
      }
      .order-image {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        object-fit: cover;
      }
      .location-bar {
        background: #e8f5e9;
        padding: 10px 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .location-bar i {
        color: var(--primary-green);
      }
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        display: flex;
        justify-content: space-around;
        padding: 10px 0;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        z-index: 100;
      }
      .bottom-nav .nav-item {
        text-align: center;
        color: #666;
        text-decoration: none;
        font-size: 12px;
        padding: 5px 15px;
      }
      .bottom-nav .nav-item.active {
        color: var(--primary-green);
      }
      .bottom-nav .nav-item i {
        font-size: 20px;
        display: block;
        margin-bottom: 3px;
      }
      .section {
        display: none;
      }
      .section.active {
        display: block;
      }
      .live-indicator {
        width: 8px;
        height: 8px;
        background: #4caf50;
        border-radius: 50%;
        display: inline-block;
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      .empty-state {
        text-align: center;
        padding: 60px 30px;
        color: #999;
      }
      .empty-state i {
        font-size: 60px;
        margin-bottom: 20px;
        opacity: 0.5;
      }
      .history-item {
        background: white;
        margin: 10px 15px;
        border-radius: 12px;
        padding: 15px;
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .history-item .icon {
        width: 45px;
        height: 45px;
        background: #e8f5e9;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary-green);
      }
      .profile-section {
        padding: 20px;
      }
      .profile-card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        text-align: center;
        margin-bottom: 20px;
      }
      .profile-avatar {
        width: 80px;
        height: 80px;
        background: linear-gradient(
          135deg,
          var(--primary-green),
          var(--light-green)
        );
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
        font-size: 32px;
        color: white;
      }
      .rating-stars {
        color: #ffc107;
        font-size: 20px;
      }
      .info-row {
        background: white;
        border-radius: 12px;
        margin-bottom: 10px;
      }
      .info-row .item {
        padding: 15px;
        display: flex;
        align-items: center;
        gap: 15px;
        border-bottom: 1px solid #f0f0f0;
      }
      .info-row .item:last-child {
        border-bottom: none;
      }
      .info-row .item i {
        color: var(--primary-green);
        width: 24px;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="header">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h5 class="mb-0">ðŸ‘‹ Hello, <span id="workerName">Worker</span></h5>
          <small id="employeeId">EMP-0000</small>
        </div>
        <div
          class="duty-toggle off-duty"
          id="dutyToggle"
          onclick="toggleDuty()"
        >
          <span id="dutyStatus">OFF DUTY</span>
        </div>
      </div>
    </div>

    <!-- Stats Row -->
    <div class="stats-row">
      <div class="stat-mini">
        <div class="number" id="todayOrders">0</div>
        <div class="small text-muted">Today</div>
      </div>
      <div class="stat-mini">
        <div class="number" id="pendingOrders">0</div>
        <div class="small text-muted">Pending</div>
      </div>
      <div class="stat-mini">
        <div class="number" id="completedOrders">0</div>
        <div class="small text-muted">Completed</div>
      </div>
      <div class="stat-mini">
        <div class="number" id="totalEarnings">â‚¹0</div>
        <div class="small text-muted">Earnings</div>
      </div>
    </div>

    <!-- Assigned Orders Section -->
    <section id="ordersSection" class="section active">
      <div class="d-flex justify-content-between align-items-center px-3 py-2">
        <h6 class="mb-0">My Orders</h6>
        <span class="live-indicator"></span>
      </div>
      <div id="assignedOrdersList">
        <div class="empty-state">
          <i class="bi bi-box-seam"></i>
          <h5>No Orders Assigned</h5>
          <p>Go on duty to receive orders or browse available pickups</p>
        </div>
      </div>
    </section>

    <!-- Available Pickups Section -->
    <section id="pickupsSection" class="section">
      <div class="d-flex justify-content-between align-items-center px-3 py-2">
        <h6 class="mb-0">Available Pickups Nearby</h6>
        <button
          class="btn btn-sm btn-outline-success"
          onclick="loadNearbyOrders()"
        >
          <i class="bi bi-arrow-clockwise"></i>
        </button>
      </div>
      <div id="nearbyOrdersList">
        <div class="empty-state">
          <i class="bi bi-geo-alt"></i>
          <h5>Enable Location</h5>
          <p>Allow location access to see nearby pickups</p>
          <button class="btn btn-success" onclick="enableLocation()">
            <i class="bi bi-geo-alt"></i> Enable Location
          </button>
        </div>
      </div>
    </section>

    <!-- History Section -->
    <section id="historySection" class="section">
      <div class="px-3 py-2">
        <h6 class="mb-0">Completed Orders</h6>
      </div>
      <div id="historyList">
        <div class="empty-state">
          <i class="bi bi-clock-history"></i>
          <h5>No History Yet</h5>
          <p>Your completed orders will appear here</p>
        </div>
      </div>
    </section>

    <!-- Profile Section -->
    <section id="profileSection" class="section">
      <div class="profile-section">
        <div class="profile-card">
          <div class="profile-avatar" id="profileInitials">W</div>
          <h5 id="profileName">Worker Name</h5>
          <p class="text-muted mb-2" id="profileRole">WORKER</p>
          <div class="rating-stars" id="profileRating">
            <i class="bi bi-star-fill"></i>
            <i class="bi bi-star-fill"></i>
            <i class="bi bi-star-fill"></i>
            <i class="bi bi-star-fill"></i>
            <i class="bi bi-star"></i>
            <span class="text-dark ms-2">4.0</span>
          </div>
        </div>

        <div class="info-row">
          <div class="item">
            <i class="bi bi-telephone"></i>
            <div>
              <small class="text-muted">Phone</small>
              <div id="profilePhone">+91 XXXXXXXXXX</div>
            </div>
          </div>
          <div class="item">
            <i class="bi bi-person-badge"></i>
            <div>
              <small class="text-muted">Employee ID</small>
              <div id="profileEmpId">EMP-0000</div>
            </div>
          </div>
          <div class="item">
            <i class="bi bi-truck"></i>
            <div>
              <small class="text-muted">Vehicle</small>
              <div id="profileVehicle">Not Assigned</div>
            </div>
          </div>
          <div class="item">
            <i class="bi bi-geo"></i>
            <div>
              <small class="text-muted">Assigned Area</small>
              <div id="profileArea">Not Assigned</div>
            </div>
          </div>
        </div>

        <div class="info-row">
          <div class="item">
            <i class="bi bi-check-circle"></i>
            <div>
              <small class="text-muted">Total Completed</small>
              <div id="profileCompleted">0 orders</div>
            </div>
          </div>
          <div class="item">
            <i class="bi bi-calendar"></i>
            <div>
              <small class="text-muted">Joined On</small>
              <div id="profileJoined">--</div>
            </div>
          </div>
        </div>

        <button class="btn btn-outline-danger w-100 mt-3" onclick="logout()">
          <i class="bi bi-box-arrow-right"></i> Logout
        </button>
      </div>
    </section>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
      <a class="nav-item active" href="#" data-section="orders">
        <i class="bi bi-box-seam"></i>
        My Orders
      </a>
      <a class="nav-item" href="#" data-section="pickups">
        <i class="bi bi-geo-alt"></i>
        Pickups
      </a>
      <a class="nav-item" href="#" data-section="history">
        <i class="bi bi-clock-history"></i>
        History
      </a>
      <a class="nav-item" href="#" data-section="profile">
        <i class="bi bi-person"></i>
        Profile
      </a>
    </div>

    <!-- Status Update Modal -->
    <div class="modal fade" id="statusModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-bottom">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h6 class="modal-title">Update Order Status</h6>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="currentOrderId" />
            <div class="d-grid gap-2">
              <button
                class="btn btn-outline-primary btn-lg"
                onclick="updateStatus('PICKED_UP')"
              >
                <i class="bi bi-box-seam"></i> Mark as Picked Up
              </button>
              <button
                class="btn btn-outline-info btn-lg"
                onclick="updateStatus('IN_TRANSIT')"
              >
                <i class="bi bi-truck"></i> In Transit
              </button>
              <button
                class="btn btn-success btn-lg"
                onclick="updateStatus('COMPLETED')"
              >
                <i class="bi bi-check-circle"></i> Mark Completed
              </button>
              <button
                class="btn btn-outline-danger"
                onclick="updateStatus('FAILED')"
              >
                <i class="bi bi-x-circle"></i> Unable to Complete
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API_BASE = "/api";
      let workerData = null;
      let isOnDuty = false;
      let locationWatchId = null;
      let currentLocation = null;

      document.addEventListener("DOMContentLoaded", () => {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "/index.html";
          return;
        }

        loadProfile();
        setupNavigation();
        startLocationTracking();
      });

      function setupNavigation() {
        document.querySelectorAll(".bottom-nav .nav-item").forEach((item) => {
          item.addEventListener("click", (e) => {
            e.preventDefault();
            const section = e.currentTarget.dataset.section;

            // Update nav
            document
              .querySelectorAll(".bottom-nav .nav-item")
              .forEach((i) => i.classList.remove("active"));
            e.currentTarget.classList.add("active");

            // Show section
            document
              .querySelectorAll(".section")
              .forEach((s) => s.classList.remove("active"));
            document
              .getElementById(section + "Section")
              .classList.add("active");

            // Load data
            if (section === "pickups") loadNearbyOrders();
            if (section === "history") loadHistory();
          });
        });
      }

      async function loadProfile() {
        try {
          const res = await fetch(`${API_BASE}/users/profile`, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });
          const data = await res.json();

          if (!data.success) {
            logout();
            return;
          }

          // Check if user is worker or driver
          if (!["WORKER", "DRIVER"].includes(data.user.role)) {
            alert("This dashboard is for workers/drivers only");
            window.location.href = "/dashboard.html";
            return;
          }

          workerData = data.user;

          // Update header
          document.getElementById("workerName").textContent =
            workerData.profile?.name?.split(" ")[0] || "Worker";
          document.getElementById("employeeId").textContent =
            workerData.workerInfo?.employeeId || "N/A";

          // Update duty status
          isOnDuty = workerData.workerInfo?.isOnDuty || false;
          updateDutyUI();

          // Update profile section
          updateProfileUI();

          // Load assigned orders
          loadAssignedOrders();
        } catch (error) {
          console.error("Profile load error:", error);
        }
      }

      function updateDutyUI() {
        const toggle = document.getElementById("dutyToggle");
        const status = document.getElementById("dutyStatus");

        if (isOnDuty) {
          toggle.classList.remove("off-duty");
          toggle.classList.add("on-duty");
          status.textContent = "ON DUTY";
        } else {
          toggle.classList.remove("on-duty");
          toggle.classList.add("off-duty");
          status.textContent = "OFF DUTY";
        }
      }

      function updateProfileUI() {
        if (!workerData) return;

        const name = workerData.profile?.name || "Worker";
        document.getElementById("profileName").textContent = name;
        document.getElementById("profileInitials").textContent = name
          .charAt(0)
          .toUpperCase();
        document.getElementById("profileRole").textContent = workerData.role;
        document.getElementById("profilePhone").textContent = workerData.phone;
        document.getElementById("profileEmpId").textContent =
          workerData.workerInfo?.employeeId || "N/A";
        document.getElementById("profileVehicle").textContent =
          workerData.workerInfo?.vehicleNumber || "Not Assigned";
        document.getElementById("profileArea").textContent =
          workerData.workerInfo?.assignedArea || "Not Assigned";
        document.getElementById("profileCompleted").textContent =
          `${workerData.workerInfo?.completedOrders || 0} orders`;

        if (workerData.workerInfo?.joiningDate) {
          document.getElementById("profileJoined").textContent = new Date(
            workerData.workerInfo.joiningDate,
          ).toLocaleDateString();
        }

        // Rating
        const rating = workerData.workerInfo?.rating || 0;
        let starsHtml = "";
        for (let i = 1; i <= 5; i++) {
          starsHtml += `<i class="bi bi-star${i <= rating ? "-fill" : ""}"></i>`;
        }
        starsHtml += `<span class="text-dark ms-2">${rating.toFixed(1)}</span>`;
        document.getElementById("profileRating").innerHTML = starsHtml;
      }

      async function toggleDuty() {
        try {
          const res = await fetch(`${API_BASE}/users/duty-status`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
            body: JSON.stringify({ isOnDuty: !isOnDuty }),
          });
          const data = await res.json();

          if (data.success) {
            isOnDuty = data.isOnDuty;
            updateDutyUI();

            if (isOnDuty) {
              startLocationSharing();
            } else {
              stopLocationSharing();
            }
          } else {
            alert(data.message || "Failed to update status");
          }
        } catch (error) {
          console.error("Toggle duty error:", error);
        }
      }

      async function loadAssignedOrders() {
        try {
          const res = await fetch(`${API_BASE}/orders/worker/assigned`, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });
          const data = await res.json();

          if (data.success && data.orders.length > 0) {
            document.getElementById("pendingOrders").textContent = data.count;

            document.getElementById("assignedOrdersList").innerHTML =
              data.orders
                .map(
                  (o) => `
                        <div class="order-card ${isUrgent(o.scheduledDate, o.scheduledTime) ? "urgent" : ""}">
                            <div class="header-strip"></div>
                            <div class="content">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <span class="order-id">${o.orderId}</span>
                                        <span class="badge bg-${getStatusColor(o.status)} ms-2">${o.status}</span>
                                    </div>
                                    ${
                                      o.scanData?.imageUrl
                                        ? `
                                        <img src="${o.scanData.imageUrl}" class="order-image" alt="Waste">
                                    `
                                        : ""
                                    }
                                </div>
                                <div class="customer-name mt-2">${o.customer?.name || "Customer"}</div>
                                <div class="small text-muted"><i class="bi bi-telephone"></i> ${o.customer?.phone || "N/A"}</div>
                                <div class="waste-tags">
                                    ${o.wasteTypes?.map((w) => `<span class="waste-tag">${w}</span>`).join("") || ""}
                                </div>
                                <div class="d-flex justify-content-between small">
                                    <span><i class="bi bi-box"></i> ${o.estimatedQuantity} kg</span>
                                    <span><i class="bi bi-calendar"></i> ${new Date(o.scheduledDate).toLocaleDateString()}</span>
                                    <span><i class="bi bi-clock"></i> ${o.scheduledTime}</span>
                                </div>
                            </div>
                            <div class="location-bar">
                                <i class="bi bi-geo-alt-fill"></i>
                                <span class="small flex-grow-1">${o.location?.address || "Location not specified"}</span>
                                <a href="https://www.google.com/maps?q=${o.location?.coordinates?.lat},${o.location?.coordinates?.lng}" 
                                   target="_blank" class="btn btn-sm btn-success">
                                    <i class="bi bi-navigation"></i>
                                </a>
                            </div>
                            <div class="action-row">
                                <button class="btn btn-outline-primary" onclick="callCustomer('${o.customer?.phone}')">
                                    <i class="bi bi-telephone"></i> Call
                                </button>
                                <button class="btn btn-success" onclick="showStatusModal('${o.id}', '${o.orderId}')">
                                    <i class="bi bi-check2-circle"></i> Update
                                </button>
                            </div>
                        </div>
                    `,
                )
                .join("");
          } else {
            document.getElementById("pendingOrders").textContent = "0";
            document.getElementById("assignedOrdersList").innerHTML = `
                        <div class="empty-state">
                            <i class="bi bi-box-seam"></i>
                            <h5>No Orders Assigned</h5>
                            <p>Go on duty to receive orders or browse available pickups</p>
                        </div>
                    `;
          }
        } catch (error) {
          console.error("Load orders error:", error);
        }
      }

      async function loadNearbyOrders() {
        if (!currentLocation) {
          enableLocation();
          return;
        }

        try {
          const res = await fetch(
            `${API_BASE}/orders/worker/pending?lat=${currentLocation.lat}&lng=${currentLocation.lng}&radius=10`,
            {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            },
          );
          const data = await res.json();

          if (data.success && data.orders.length > 0) {
            document.getElementById("nearbyOrdersList").innerHTML = data.orders
              .map(
                (o) => `
                        <div class="order-card">
                            <div class="header-strip"></div>
                            <div class="content">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <span class="order-id">${o.orderId}</span>
                                        <span class="badge bg-warning ms-2">${o.distance} km away</span>
                                    </div>
                                    ${
                                      o.scanData?.imageUrl
                                        ? `
                                        <img src="${o.scanData.imageUrl}" class="order-image" alt="Waste">
                                    `
                                        : ""
                                    }
                                </div>
                                <div class="customer-name mt-2">${o.customer?.name || "Customer"}</div>
                                <div class="waste-tags">
                                    ${o.wasteTypes?.map((w) => `<span class="waste-tag">${w}</span>`).join("") || ""}
                                </div>
                                <div class="d-flex justify-content-between small">
                                    <span><i class="bi bi-box"></i> ${o.estimatedQuantity} kg</span>
                                    <span><i class="bi bi-calendar"></i> ${new Date(o.scheduledDate).toLocaleDateString()}</span>
                                    <span><i class="bi bi-currency-rupee"></i> ${o.estimatedValue || 0}</span>
                                </div>
                            </div>
                            <div class="location-bar">
                                <i class="bi bi-geo-alt-fill"></i>
                                <span class="small flex-grow-1">${o.location?.address || o.location?.area || "Location"}</span>
                            </div>
                            <div class="action-row">
                                <button class="btn btn-success" onclick="acceptOrder('${o.id}')">
                                    <i class="bi bi-check-lg"></i> Accept Order
                                </button>
                            </div>
                        </div>
                    `,
              )
              .join("");
          } else {
            document.getElementById("nearbyOrdersList").innerHTML = `
                        <div class="empty-state">
                            <i class="bi bi-geo-alt"></i>
                            <h5>No Pickups Nearby</h5>
                            <p>No pending orders in your area right now</p>
                        </div>
                    `;
          }
        } catch (error) {
          console.error("Load nearby orders error:", error);
        }
      }

      async function loadHistory() {
        try {
          const res = await fetch(
            `${API_BASE}/orders/worker/assigned?status=COMPLETED`,
            {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            },
          );
          const data = await res.json();

          if (data.success && data.orders.length > 0) {
            document.getElementById("completedOrders").textContent = data.count;

            document.getElementById("historyList").innerHTML = data.orders
              .map(
                (o) => `
                        <div class="history-item">
                            <div class="icon">
                                <i class="bi bi-check-lg"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-medium">${o.orderId}</div>
                                <div class="small text-muted">${o.customer?.name || "Customer"}</div>
                            </div>
                            <div class="text-end">
                                <div class="text-success fw-medium">â‚¹${o.actualValue || o.estimatedValue || 0}</div>
                                <div class="small text-muted">${new Date(o.completedAt || o.scheduledDate).toLocaleDateString()}</div>
                            </div>
                        </div>
                    `,
              )
              .join("");
          } else {
            document.getElementById("completedOrders").textContent = "0";
            document.getElementById("historyList").innerHTML = `
                        <div class="empty-state">
                            <i class="bi bi-clock-history"></i>
                            <h5>No History Yet</h5>
                            <p>Your completed orders will appear here</p>
                        </div>
                    `;
          }
        } catch (error) {
          console.error("Load history error:", error);
        }
      }

      function showStatusModal(orderId, orderDisplayId) {
        document.getElementById("currentOrderId").value = orderId;
        new bootstrap.Modal(document.getElementById("statusModal")).show();
      }

      async function updateStatus(status) {
        const orderId = document.getElementById("currentOrderId").value;

        try {
          const res = await fetch(
            `${API_BASE}/orders/worker/status/${orderId}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
              body: JSON.stringify({ status }),
            },
          );
          const data = await res.json();

          if (data.success) {
            bootstrap.Modal.getInstance(
              document.getElementById("statusModal"),
            ).hide();
            loadAssignedOrders();
            alert(`Order status updated to ${status}`);
          } else {
            alert(data.message || "Failed to update status");
          }
        } catch (error) {
          alert("Error updating status: " + error.message);
        }
      }

      async function acceptOrder(orderId) {
        if (!isOnDuty) {
          alert("Please go on duty first to accept orders");
          return;
        }

        try {
          const res = await fetch(
            `${API_BASE}/orders/worker/assign/${orderId}`,
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            },
          );
          const data = await res.json();

          if (data.success) {
            alert("Order accepted! Check My Orders tab.");
            loadAssignedOrders();
            loadNearbyOrders();

            // Switch to orders tab
            document.querySelector('[data-section="orders"]').click();
          } else {
            alert(data.message || "Failed to accept order");
          }
        } catch (error) {
          alert("Error accepting order: " + error.message);
        }
      }

      function callCustomer(phone) {
        if (phone) {
          window.location.href = `tel:${phone}`;
        }
      }

      function isUrgent(date, time) {
        const scheduled = new Date(date);
        const now = new Date();
        const diffHours = (scheduled - now) / (1000 * 60 * 60);
        return diffHours < 2;
      }

      function getStatusColor(status) {
        const colors = {
          PENDING: "warning",
          ASSIGNED: "info",
          PICKED_UP: "primary",
          IN_TRANSIT: "primary",
          COMPLETED: "success",
          CANCELLED: "danger",
          FAILED: "danger",
        };
        return colors[status] || "secondary";
      }

      // Location tracking
      function startLocationTracking() {
        if ("geolocation" in navigator) {
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              currentLocation = {
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
              };
            },
            (err) => console.log("Location error:", err),
            { enableHighAccuracy: true },
          );
        }
      }

      function enableLocation() {
        if ("geolocation" in navigator) {
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              currentLocation = {
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
              };
              loadNearbyOrders();
            },
            (err) => {
              alert("Please enable location access in your browser settings");
            },
            { enableHighAccuracy: true },
          );
        } else {
          alert("Geolocation not supported");
        }
      }

      function startLocationSharing() {
        if ("geolocation" in navigator) {
          locationWatchId = navigator.geolocation.watchPosition(
            async (pos) => {
              const location = {
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
                heading: pos.coords.heading || 0,
                speed: pos.coords.speed ? pos.coords.speed * 3.6 : 0, // Convert to km/h
                accuracy: pos.coords.accuracy,
              };

              currentLocation = { lat: location.lat, lng: location.lng };

              // Send to server
              try {
                await fetch(`${API_BASE}/users/live-location`, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${localStorage.getItem("token")}`,
                  },
                  body: JSON.stringify(location),
                });
              } catch (error) {
                console.error("Location update error:", error);
              }
            },
            (err) => console.error("Watch position error:", err),
            { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 },
          );
        }
      }

      function stopLocationSharing() {
        if (locationWatchId) {
          navigator.geolocation.clearWatch(locationWatchId);
          locationWatchId = null;
        }
      }

      function logout() {
        localStorage.removeItem("token");
        window.location.href = "/index.html";
      }

      // Auto-refresh orders every 30 seconds
      setInterval(() => {
        if (
          document.getElementById("ordersSection").classList.contains("active")
        ) {
          loadAssignedOrders();
        }
      }, 30000);
    </script>
  </body>
</html>
