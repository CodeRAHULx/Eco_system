<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EcoSustain - Subscription Plans</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://js.stripe.com/v3/"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        min-height: 100vh;
        color: #fff;
      }

      .header {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .back-btn {
        background: none;
        border: none;
        color: #fff;
        font-size: 20px;
        cursor: pointer;
      }

      .header-title {
        font-size: 1.2rem;
        font-weight: 600;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
      }

      .hero {
        text-align: center;
        padding: 40px 20px;
      }

      .hero h1 {
        font-size: 2rem;
        margin-bottom: 10px;
        background: linear-gradient(90deg, #4ade80, #22d3ee);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .hero p {
        color: rgba(255, 255, 255, 0.7);
        font-size: 1rem;
      }

      .current-plan {
        background: rgba(74, 222, 128, 0.1);
        border: 1px solid rgba(74, 222, 128, 0.3);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
        text-align: center;
      }

      .current-plan h3 {
        color: #4ade80;
        margin-bottom: 10px;
      }

      .plans-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }

      .plan-card {
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 30px;
        text-align: center;
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
      }

      .plan-card:hover {
        transform: translateY(-5px);
        border-color: #4ade80;
      }

      .plan-card.popular {
        border-color: #4ade80;
      }

      .popular-badge {
        position: absolute;
        top: 15px;
        right: -30px;
        background: linear-gradient(90deg, #4ade80, #22d3ee);
        color: #1a1a2e;
        padding: 5px 40px;
        font-size: 0.75rem;
        font-weight: bold;
        transform: rotate(45deg);
      }

      .plan-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        font-size: 24px;
      }

      .plan-card:nth-child(1) .plan-icon {
        background: rgba(59, 130, 246, 0.2);
        color: #3b82f6;
      }
      .plan-card:nth-child(2) .plan-icon {
        background: rgba(74, 222, 128, 0.2);
        color: #4ade80;
      }
      .plan-card:nth-child(3) .plan-icon {
        background: rgba(251, 191, 36, 0.2);
        color: #fbbf24;
      }

      .plan-name {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 10px;
      }

      .plan-price {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .plan-price span {
        font-size: 1rem;
        color: rgba(255, 255, 255, 0.5);
      }

      .plan-features {
        list-style: none;
        margin: 25px 0;
        text-align: left;
      }

      .plan-features li {
        padding: 10px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .plan-features li i {
        color: #4ade80;
      }

      .plan-btn {
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .plan-btn.primary {
        background: linear-gradient(90deg, #4ade80, #22d3ee);
        color: #1a1a2e;
      }

      .plan-btn.secondary {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
      }

      .plan-btn:hover {
        transform: scale(1.02);
      }

      .plan-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .features-section {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 40px;
      }

      .features-section h2 {
        text-align: center;
        margin-bottom: 30px;
        color: #4ade80;
      }

      .features-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
      }

      .feature-item {
        text-align: center;
        padding: 20px;
      }

      .feature-item i {
        font-size: 2rem;
        color: #4ade80;
        margin-bottom: 10px;
      }

      .feature-item h4 {
        margin-bottom: 5px;
      }

      .feature-item p {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.6);
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        flex-direction: column;
        gap: 20px;
      }

      .loading-overlay.active {
        display: flex;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-top-color: #4ade80;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .toast {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        padding: 15px 30px;
        border-radius: 25px;
        font-weight: 500;
        z-index: 1000;
        display: none;
      }

      .toast.success {
        background: rgba(74, 222, 128, 0.9);
        color: #1a1a2e;
      }
      .toast.error {
        background: rgba(239, 68, 68, 0.9);
      }

      .faq-section {
        margin-bottom: 40px;
      }

      .faq-section h2 {
        text-align: center;
        margin-bottom: 20px;
        color: #4ade80;
      }

      .faq-item {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        margin-bottom: 10px;
        overflow: hidden;
      }

      .faq-question {
        padding: 15px 20px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .faq-answer {
        padding: 0 20px;
        max-height: 0;
        overflow: hidden;
        transition: all 0.3s;
        color: rgba(255, 255, 255, 0.7);
      }

      .faq-item.active .faq-answer {
        padding: 15px 20px;
        max-height: 200px;
      }

      @media (max-width: 600px) {
        .hero h1 {
          font-size: 1.5rem;
        }
        .plan-price {
          font-size: 2rem;
        }
        .plans-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header class="header">
      <button class="back-btn" onclick="history.back()">
        <i class="fas fa-arrow-left"></i>
      </button>
      <span class="header-title">Subscription Plans</span>
      <div style="width: 24px"></div>
    </header>

    <div class="container">
      <div class="hero">
        <h1>ðŸŒ± Choose Your Plan</h1>
        <p>Unlock premium features and help save the planet</p>
      </div>

      <div class="current-plan" id="currentPlan">
        <h3>Loading current plan...</h3>
      </div>

      <div class="plans-grid" id="plansContainer">
        <div style="text-align: center; padding: 40px">
          <div class="spinner"></div>
          <p style="margin-top: 20px">Loading plans...</p>
        </div>
      </div>

      <div class="features-section">
        <h2>Why Upgrade?</h2>
        <div class="features-grid">
          <div class="feature-item">
            <i class="fas fa-truck"></i>
            <h4>More Pickups</h4>
            <p>Schedule more waste pickups per month</p>
          </div>
          <div class="feature-item">
            <i class="fas fa-brain"></i>
            <h4>Advanced AI</h4>
            <p>Better waste detection & value estimation</p>
          </div>
          <div class="feature-item">
            <i class="fas fa-location-dot"></i>
            <h4>Live Tracking</h4>
            <p>Track your pickup in real-time</p>
          </div>
          <div class="feature-item">
            <i class="fas fa-headset"></i>
            <h4>Priority Support</h4>
            <p>Get help faster when you need it</p>
          </div>
        </div>
      </div>

      <div class="faq-section">
        <h2>Frequently Asked Questions</h2>

        <div class="faq-item">
          <div class="faq-question" onclick="toggleFaq(this)">
            <span>How do I cancel my subscription?</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="faq-answer">
            You can cancel anytime from your dashboard. Your subscription will
            remain active until the end of the billing period.
          </div>
        </div>

        <div class="faq-item">
          <div class="faq-question" onclick="toggleFaq(this)">
            <span>What payment methods do you accept?</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="faq-answer">
            We accept all major credit/debit cards, UPI, and net banking through
            Stripe payment gateway.
          </div>
        </div>

        <div class="faq-item">
          <div class="faq-question" onclick="toggleFaq(this)">
            <span>Can I upgrade or downgrade my plan?</span>
            <i class="fas fa-chevron-down"></i>
          </div>
          <div class="faq-answer">
            Yes! You can change your plan at any time. Upgrades are effective
            immediately, and downgrades take effect at the next billing cycle.
          </div>
        </div>
      </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
      <div class="spinner"></div>
      <p>Processing payment...</p>
    </div>

    <div class="toast" id="toast"></div>

    <script>
      const API_BASE = "/api";
      const token = localStorage.getItem("token");
      let currentPlan = "FREE";
      let plans = [];

      // Check auth
      if (!token) {
        window.location.href = "/index.html?redirect=subscription";
      }

      // Load on page load
      document.addEventListener("DOMContentLoaded", () => {
        loadCurrentSubscription();
        loadPlans();
        checkPaymentStatus();
      });

      async function loadCurrentSubscription() {
        try {
          const response = await fetch(`${API_BASE}/payment/subscription`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await response.json();

          if (data.success) {
            currentPlan = data.subscription?.plan || "FREE";
            const status = data.subscription?.status || "inactive";
            const endDate = data.subscription?.endDate;

            let html = `<h3>Current Plan: ${currentPlan}</h3>`;
            if (currentPlan !== "FREE" && endDate) {
              const expiry = new Date(endDate).toLocaleDateString();
              html += `<p>Status: ${status} | Expires: ${expiry}</p>`;
            } else {
              html += `<p>Upgrade to unlock premium features!</p>`;
            }
            document.getElementById("currentPlan").innerHTML = html;
          }
        } catch (error) {
          console.error("Error loading subscription:", error);
          document.getElementById("currentPlan").innerHTML = `
                    <h3>Current Plan: FREE</h3>
                    <p>Upgrade to unlock premium features!</p>
                `;
        }
      }

      async function loadPlans() {
        try {
          const response = await fetch(`${API_BASE}/payment/plans`);
          const data = await response.json();

          if (data.success) {
            plans = data.plans;
            renderPlans();
          } else {
            throw new Error(data.message || "Failed to load plans");
          }
        } catch (error) {
          console.error("Error loading plans:", error);
          document.getElementById("plansContainer").innerHTML = `
                    <div style="text-align: center; padding: 40px; grid-column: 1/-1;">
                        <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #ef4444; margin-bottom: 20px;"></i>
                        <h3>Failed to load plans</h3>
                        <p style="color: rgba(255,255,255,0.6);">Please try again later</p>
                        <button onclick="loadPlans()" style="margin-top: 20px; padding: 10px 30px; background: #4ade80; border: none; border-radius: 8px; cursor: pointer;">
                            Retry
                        </button>
                    </div>
                `;
        }
      }

      function renderPlans() {
        const icons = {
          BASIC: "fas fa-leaf",
          PREMIUM: "fas fa-crown",
          ENTERPRISE: "fas fa-building",
        };

        let html = "";
        plans.forEach((plan, index) => {
          const isCurrentPlan = currentPlan === plan.id;
          const isPopular = plan.id === "PREMIUM";

          html += `
                    <div class="plan-card ${isPopular ? "popular" : ""}">
                        ${isPopular ? '<div class="popular-badge">POPULAR</div>' : ""}
                        <div class="plan-icon">
                            <i class="${icons[plan.id] || "fas fa-check"}"></i>
                        </div>
                        <div class="plan-name">${plan.name}</div>
                        <div class="plan-price">â‚¹${plan.priceInRupees}<span>/month</span></div>
                        <ul class="plan-features">
                            ${plan.features
                              .map(
                                (f) => `
                                <li><i class="fas fa-check"></i> ${f}</li>
                            `,
                              )
                              .join("")}
                        </ul>
                        <button class="plan-btn ${isPopular ? "primary" : "secondary"}" 
                                onclick="subscribePlan('${plan.id}')"
                                ${isCurrentPlan ? "disabled" : ""}>
                            ${isCurrentPlan ? "Current Plan" : "Subscribe Now"}
                        </button>
                    </div>
                `;
        });

        document.getElementById("plansContainer").innerHTML = html;
      }

      async function subscribePlan(planId) {
        if (!token) {
          showToast("Please login first", "error");
          setTimeout(() => {
            window.location.href = "/index.html?redirect=subscription";
          }, 1500);
          return;
        }

        document.getElementById("loadingOverlay").classList.add("active");

        try {
          const response = await fetch(`${API_BASE}/payment/create-order`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ plan: planId }),
          });

          const data = await response.json();

          if (!data.success) {
            throw new Error(data.message || "Failed to create order");
          }

          // Handle Stripe checkout
          if (data.provider === "stripe" && data.checkoutUrl) {
            window.location.href = data.checkoutUrl;
            return;
          }

          // Handle Razorpay (fallback)
          if (data.provider === "razorpay") {
            initRazorpay(data);
            return;
          }

          throw new Error("No payment provider available");
        } catch (error) {
          console.error("Payment error:", error);
          document.getElementById("loadingOverlay").classList.remove("active");
          showToast(error.message || "Payment failed", "error");
        }
      }

      function initRazorpay(data) {
        const options = {
          key: data.key,
          amount: data.order.amount,
          currency: data.order.currency,
          name: "EcoSustain",
          description: `${data.plan.name} Subscription`,
          order_id: data.order.id,
          handler: async function (response) {
            await verifyPayment(response);
          },
          prefill: {
            name: "",
            email: "",
          },
          theme: {
            color: "#4ade80",
          },
          modal: {
            ondismiss: function () {
              document
                .getElementById("loadingOverlay")
                .classList.remove("active");
            },
          },
        };

        const rzp = new Razorpay(options);
        rzp.open();
        document.getElementById("loadingOverlay").classList.remove("active");
      }

      async function verifyPayment(response) {
        document.getElementById("loadingOverlay").classList.add("active");

        try {
          const verifyResponse = await fetch(`${API_BASE}/payment/verify`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(response),
          });

          const data = await verifyResponse.json();

          if (data.success) {
            showToast("Subscription activated successfully!", "success");
            setTimeout(() => {
              window.location.href = "/dashboard.html?subscription=success";
            }, 1500);
          } else {
            throw new Error(data.message || "Verification failed");
          }
        } catch (error) {
          showToast(error.message || "Payment verification failed", "error");
        } finally {
          document.getElementById("loadingOverlay").classList.remove("active");
        }
      }

      // Check if returning from Stripe checkout
      function checkPaymentStatus() {
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get("session_id");
        const paymentStatus = urlParams.get("payment");

        if (paymentStatus === "success" && sessionId) {
          verifyStripePayment(sessionId);
        } else if (paymentStatus === "cancelled") {
          showToast("Payment was cancelled", "error");
        }
      }

      async function verifyStripePayment(sessionId) {
        document.getElementById("loadingOverlay").classList.add("active");

        try {
          const response = await fetch(`${API_BASE}/payment/verify-stripe`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ session_id: sessionId }),
          });

          const data = await response.json();

          if (data.success) {
            showToast("Subscription activated successfully!", "success");
            setTimeout(() => {
              window.location.href = "/dashboard.html?subscription=success";
            }, 2000);
          } else {
            throw new Error(data.message);
          }
        } catch (error) {
          showToast(error.message || "Verification failed", "error");
        } finally {
          document.getElementById("loadingOverlay").classList.remove("active");
        }
      }

      function toggleFaq(element) {
        element.parentElement.classList.toggle("active");
      }

      function showToast(message, type = "info") {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.className = "toast " + type;
        toast.style.display = "block";
        setTimeout(() => {
          toast.style.display = "none";
        }, 3000);
      }
    </script>
  </body>
</html>
